<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&family=DotGothic16&display=swap" rel="stylesheet">
    <title>Bip Man≈ìuvre - Agent</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        @font-face {
            font-family: 'Pixel';
            src: url('data:font/woff2;base64,') format('woff2');
        }
        body {
            font-family: 'DotGothic16', monospace;
            background: #000;
            color: #0f0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        .login-screen {
            background: #000;
            color: #0f0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        .login-form {
            max-width: 300px;
            width: 100%;
        }
        .login-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: #0f0;
            text-transform: uppercase;
        }
        .login-instructions {
            font-size: 14px;
            margin-bottom: 30px;
            line-height: 1.6;
            color: #0f0;
        }
        .instruction-item {
            margin-bottom: 15px;
            text-align: left;
        }
        .instruction-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .instruction-example {
            font-style: italic;
            color: #0a0;
            font-size: 12px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 2px solid #0f0;
            color: #0f0;
            font-family: 'DotGothic16', monospace;
            font-size: 16px;
            text-transform: uppercase;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #0a0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .btn-connect {
            width: 100%;
            padding: 15px;
            background: #0f0;
            color: #000;
            border: none;
            font-family: 'DotGothic16', monospace;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
        }
        .btn-connect:active {
            background: #0a0;
        }
        .error-message {
            color: #f00;
            margin-top: 10px;
            font-size: 12px;
        }
        .instruction-screen {
            background: #000;
            color: #0f0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        .instruction-content {
            max-width: 350px;
            width: 100%;
        }
        .instruction-warning {
            font-size: 18px;
            margin-bottom: 30px;
            color: #ff0;
            text-transform: uppercase;
        }
        .instruction-list {
            text-align: left;
            margin-bottom: 30px;
            line-height: 2;
        }
        .instruction-list li {
            margin-bottom: 10px;
        }
        .btn-continue {
            width: 100%;
            padding: 15px;
            background: #0f0;
            color: #000;
            border: none;
            font-family: 'DotGothic16', monospace;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
        }
        .bip-container {
            background: #000;
            height: 80vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .bip-device {
            flex: 1;
            background: #1a1a1a;
            border: 3px solid #333;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }
        .bip-screen {
            background: #c3d6a5;
            border: 2px solid #96a57d;
            border-radius: 5px;
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            font-family: 'DotGothic16', monospace;
            position: relative;
            min-height: 200px;
            max-height: 200px;
            color: #2d3126;
        }
        .bip-screen.active {
            background: #ffeb3b;
            border-color: #f1cd00;
        }
        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
            height: 30px;
        }
        .battery-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .battery-level {
            font-size: 12px;
        }
        .battery-icon {
            width: 20px;
            height: 10px;
            border: 1px solid #2d3126;
            position: relative;
            background: #c3d6a5;
        }
        .battery-icon::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 2px;
            width: 2px;
            height: 6px;
            background: #2d3126;
        }
        .battery-fill {
            height: 100%;
            background: #2d3126;
            transition: width 0.3s;
        }
        .signal-icon {
            width: 15px;
            height: 10px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }
        .signal-bar {
            width: 2px;
            background: #2d3126;
        }
        .signal-bar:nth-child(1) { height: 30%; }
        .signal-bar:nth-child(2) { height: 50%; }
        .signal-bar:nth-child(3) { height: 70%; }
        .signal-bar:nth-child(4) { height: 100%; }
        .time-display {
            font-size: 14px;
            color: #2d3126;
        }
        .battery-level {
            color: #2d3126;
        }
        .screen-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 18px;
            line-height: 1.8;
            font-family: 'DotGothic16', monospace;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .screen-waiting {
            color: #2d3126;
            font-weight: normal;
        }
        .screen-alert {
            color: #2d3126;
            font-weight: bold;
            font-size: 20px;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* Bip buttons layout */
        .bip-buttons {
            position: relative;
            width: 270px;
            height: 130px;
            margin: 30px auto 0 auto;
            display: block;
        }

        .bip-button {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #e0e0e0;
            border: 2px solid #bbb;
            border-radius: 50%;
            color: #222;
            font-family: 'DotGothic16', monospace;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            transition: background 0.15s, color 0.15s, border-color 0.15s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.10);
            z-index: 1;
        }
        /* The main (yellow, big, centered) button */
        .bip-button.btn-yellow {
            width: 100px;
            height: 100px;
            left: 50%;
            top: 15px;
            transform: translateX(-50%);
            margin-left: 0;
            background: #ffeb3b;
            color: #333;
            border-color: #ffe300;
            font-weight: bold;
            z-index: 2;
        }
        .bip-button.btn-yellow:active {
            background: #ffe066;
        }
        /* Second button: to the right of the yellow */
        .bip-button.btn-2 {
            left: calc(50% + 70px);
            top: 40px;
        }
        /* Third button (OFF): to the right of the yellow button */
        .bip-button.btn-3 {
            left: calc(50% + 70px);
            top: 15px;
        }
        .bip-button:active:not(.btn-yellow) {
            background: #cacaca;
            color: #000;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- √âcran de connexion -->
        <div v-if="screen === 'login'" class="login-screen">
            <div class="login-form">
                <div class="login-title">BIP MAN≈íUVRE</div>
                <div class="login-instructions">
                    <div class="instruction-item">
                        <span class="instruction-label">Agents de Collonges:</span>
                        <span class="instruction-example">V + matricule (ex: V30001)</span>
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-label">Autres agents:</span>
                        <span class="instruction-example">3 premi√®res lettres nom + pr√©nom (ex: DUPJEA pour DUPONT Jean)</span>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label" for="matricule">Identifiant:</label>
                    <input 
                        type="text" 
                        id="matricule"
                        v-model="matricule" 
                        @keyup.enter="connect"
                        autocomplete="off"
                        placeholder="Ex: V30001 ou DUPJEA"
                    />
                </div>
                <button class="btn-connect" @click="connect">CONNEXION</button>
                <div v-if="loginError" class="error-message">{{ loginError }}</div>
            </div>
        </div>

        <!-- √âcran d'instructions -->
        <div v-if="screen === 'instructions'" class="instruction-screen">
            <div class="instruction-content">
                <div class="instruction-warning">‚ö†Ô∏è IMPORTANT ‚ö†Ô∏è</div>
                <ul class="instruction-list">
                    <li>üîä Mettez le son √† FOND</li>
                    <li>üì± Ne verrouillez PAS votre t√©l√©phone</li>
                    <li>üîî Autorisez les notifications</li>
                    <li>üì≥ Autorisez les vibrations</li>
                </ul>
                <button class="btn-continue" @click="startBip">CONTINUER</button>
            </div>
        </div>

        <!-- √âcran du bip -->
        <div v-if="screen === 'bip'" class="bip-container">
            <div class="bip-device">
                <div :class="['bip-screen', { active: isAlertActive }]">
                    <div class="screen-header">
                        <div class="battery-info">
                            <span class="battery-level">{{ batteryLevel }}%</span>
                            <div class="battery-icon">
                                <div class="battery-fill" :style="{ width: batteryLevel + '%' }"></div>
                            </div>
                            <div v-if="isConnected" class="signal-icon">
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                            </div>
                        </div>
                        <div class="time-display">{{ currentTime }}</div>
                    </div>
                    <div class="screen-content">
                        <div v-if="!isAlertActive" class="screen-waiting">
                            CMS COLLONGES<br/>{{ agentData ? agentData.matricule : '' }}
                        </div>
                        <div v-else class="screen-alert">
                            {{ alertMessage || 'ALERTE' }}
                        </div>
                    </div>
                </div>
                <div class="bip-buttons">
                    <div :class="['bip-button', 'btn-yellow']" @click="acknowledge"></div>
                    <div class="bip-button" @click="refreshData"></div>
                    <div class="bip-button" @click="disconnect">OFF</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    screen: 'login', // login, instructions, bip
                    matricule: '',
                    loginError: '',
                    agentData: null,
                    data: null,
                    refreshInterval: null,
                    batteryLevel: 100,
                    currentTime: '',
                    timeInterval: null,
                    isConnected: false,
                    isAlertActive: false,
                    alertOD: '',
                    alertMessage: '',
                    audio: null,
                    silentAudio: null,
                    vibrationInterval: null,
                    permissionsGranted: false
                }
            },
            methods: {
                async connect() {
                    if (!this.matricule.trim()) {
                        this.loginError = 'Veuillez entrer un identifiant';
                        return;
                    }
                    
                    this.loginError = '';
                    this.loading = true;

                    try {
                        const response = await fetch('/getManoeuvreDetails');
                        if (!response.ok) throw new Error('Erreur de connexion');
                        const data = await response.json();
                        
                        // Chercher l'agent
                        if (!data.Manoeuvrants || data.Manoeuvrants.length < 2) {
                            this.loginError = 'Aucune man≈ìuvre active';
                            return;
                        }

                        const rows = data.Manoeuvrants.slice(1);
                        const agent = rows.find(row => {
                            const rowMatricule = (row[0] || '').toUpperCase();
                            const inputMatricule = this.matricule.toUpperCase();
                            return rowMatricule === inputMatricule || 
                                   rowMatricule.endsWith(inputMatricule) ||
                                   this.matchNomPrenom(row, inputMatricule);
                        });

                        if (!agent) {
                            this.loginError = 'Agent non trouv√©';
                            return;
                        }

                        this.agentData = {
                            matricule: agent[0],
                            grade: agent[1],
                            nom: agent[2],
                            prenom: agent[3],
                            engLib: agent[4],
                            engCaserne: agent[5],
                            gfo: agent[6],
                            role: agent[7],
                            statusConnexion: agent[8] || 'PENDING',
                            statusAlerte: agent[9] || 'PENDING',
                            od: agent[10] || ''
                        };

                        // Mettre √† jour le statut de connexion √† OK
                        try {
                            const connResponse = await fetch(`/changeConnexion/${this.agentData.matricule}`, {
                                method: 'POST'
                            });
                            if (connResponse.ok) {
                                this.agentData.statusConnexion = 'OK';
                                this.isConnected = true;
                            }
                        } catch (err) {
                            console.error('Error updating connection status:', err);
                            // On continue m√™me si √ßa √©choue
                        }

                        this.data = data;
                        this.screen = 'instructions';
                    } catch (err) {
                        this.loginError = 'Erreur: ' + err.message;
                        console.error('Error connecting:', err);
                    }
                },
                matchNomPrenom(row, input) {
                    // Format: 3 premi√®res lettres nom + 3 premi√®res lettres pr√©nom
                    const nom = (row[2] || '').toUpperCase().substring(0, 3);
                    const prenom = (row[3] || '').toUpperCase().substring(0, 3);
                    const expected = nom + prenom;
                    return expected === input.toUpperCase();
                },
                async requestPermissions() {
                    try {
                        // Demander autorisation notifications
                        if ('Notification' in window && Notification.permission === 'default') {
                            await Notification.requestPermission();
                        }
                        
                        // Pour vibrations, on teste directement
                        if ('vibrate' in navigator) {
                            navigator.vibrate(100);
                        }

                        this.permissionsGranted = true;
                    } catch (err) {
                        console.error('Error requesting permissions:', err);
                    }
                },
                async startBip() {
                    await this.requestPermissions();
                    this.screen = 'bip';
                    this.updateTime();
                    this.timeInterval = setInterval(() => this.updateTime(), 1000);
                    this.startBatteryMonitoring();
                    this.fetchData();
                    this.refreshInterval = setInterval(() => this.fetchData(), 5000);
                    this.loadAudio();
                },
                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleTimeString('fr-FR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                startBatteryMonitoring() {
                    if ('getBattery' in navigator) {
                        navigator.getBattery().then(battery => {
                            this.batteryLevel = Math.round(battery.level * 100);
                            battery.addEventListener('levelchange', () => {
                                this.batteryLevel = Math.round(battery.level * 100);
                            });
                        });
                    } else if ('battery' in navigator) {
                        navigator.battery.addEventListener('levelchange', () => {
                            this.batteryLevel = Math.round(navigator.battery.level * 100);
                        });
                    }
                },
                loadAudio() {
                    this.audio = new Audio('/sonnerie.mp3');
                    this.audio.loop = true;
                    this.audio.preload = 'auto';
                    
                    // Cr√©er un son vide (silence)
                    this.silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
                    this.silentAudio.loop = true;
                    this.silentAudio.volume = 0;
                    this.silentAudio.preload = 'auto';
                    // D√©marrer le son vide en boucle
                    this.silentAudio.play().catch(err => {
                        console.error('Error playing silent audio:', err);
                    });
                },
                async fetchData() {
                    try {
                        const response = await fetch('/getManoeuvreDetails');
                        if (!response.ok) return;
                        const data = await response.json();
                        this.data = data;

                        // Mettre √† jour les donn√©es de l'agent
                        if (data.Manoeuvrants && data.Manoeuvrants.length > 1) {
                            const rows = data.Manoeuvrants.slice(1);
                            const agent = rows.find(row => row[0] === this.agentData.matricule);
                            if (agent) {
                                this.agentData.statusConnexion = agent[8] || 'PENDING';
                                this.agentData.statusAlerte = agent[9] || 'PENDING';
                                this.isConnected = this.agentData.statusConnexion === 'OK';
                                
                                // V√©rifier si une alerte est d√©clench√©e (uniquement si DONE)
                                const previousStatus = this.isAlertActive;
                                const newStatusAlerte = this.agentData.statusAlerte;
                                
                                // L'alerte ne se d√©clenche que si statusAlerte passe √† DONE
                                this.isAlertActive = newStatusAlerte === 'DONE';
                                
                                if (this.isAlertActive && !previousStatus) {
                                    // Arr√™ter le son vide avant de d√©marrer l'alerte
                                    if (this.silentAudio) {
                                        this.silentAudio.pause();
                                    }
                                    // Construire le message d'alerte : VEHICULE-ROLE-GFO
                                    const vehicule = (this.agentData.engLib || '').toUpperCase().replace('-', '');
                                    const role = (this.agentData.role || '').toUpperCase();
                                    const gfo = (this.agentData.gfo || '').toUpperCase();
                                    this.alertMessage = `${vehicule}-${role}-${gfo}`;
                                    this.alertOD = this.agentData.od;
                                    this.startAlert();
                                } else if (!this.isAlertActive && previousStatus) {
                                    // Si on passe de DONE √† autre chose (ex: RECEIVED), arr√™ter l'alerte
                                    this.stopAlert();
                                    // Reprendre le son vide
                                    if (this.silentAudio) {
                                        this.silentAudio.play().catch(err => {
                                            console.error('Error resuming silent audio:', err);
                                        });
                                    }
                                } else if (!this.isAlertActive && !previousStatus) {
                                    // S'assurer que le son vide est en cours de lecture quand il n'y a pas d'alerte
                                    if (this.silentAudio && this.silentAudio.paused) {
                                        this.silentAudio.play().catch(err => {
                                            console.error('Error playing silent audio:', err);
                                        });
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Error fetching data:', err);
                    }
                },
                startAlert() {
                    // Vibration pattern: 1s on, 1s off (synchronis√© avec l'audio)
                    const vibratePattern = () => {
                        if ('vibrate' in navigator) {
                            navigator.vibrate(1000); // 1 seconde de vibration
                        }
                    };
                    
                    // Sonnerie: volume 0.3 puis 1 (d√©marrer en m√™me temps que la vibration)
                    if (this.audio) {
                        this.audio.volume = 0.3;
                        this.audio.play().then(() => {
                            // D√©marrer la vibration en m√™me temps que l'audio
                            vibratePattern();
                            
                            // R√©p√©ter le pattern de vibration toutes les 2 secondes (1s vibre, 1s pause)
                            this.vibrationInterval = setInterval(() => {
                                vibratePattern();
                            }, 2000);
                        }).catch(err => {
                            console.error('Error playing audio:', err);
                            // Si l'audio ne d√©marre pas, d√©marrer quand m√™me la vibration
                            vibratePattern();
                            this.vibrationInterval = setInterval(() => {
                                vibratePattern();
                            }, 2000);
                        });
                        
                        setTimeout(() => {
                            if (this.audio) {
                                this.audio.volume = 1.0;
                            }
                        }, 1000);
                    } else {
                        // Si pas d'audio, d√©marrer la vibration quand m√™me
                        vibratePattern();
                        this.vibrationInterval = setInterval(() => {
                            vibratePattern();
                        }, 2000);
                    }

                    // Notification
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Ordre de D√©part', {
                            body: `Ordre de D√©part ${this.agentData.od} d√©clench√©`,
                            icon: '/favicon.ico',
                            tag: 'manoeuvre-alert'
                        });
                    }
                },
                stopAlert() {
                    if (this.vibrationInterval) {
                        clearInterval(this.vibrationInterval);
                        this.vibrationInterval = null;
                        if ('vibrate' in navigator) {
                            navigator.vibrate(0);
                        }
                    }
                    if (this.audio) {
                        this.audio.pause();
                        this.audio.currentTime = 0;
                    }
                    // Reprendre le son vide
                    if (this.silentAudio && this.silentAudio.paused) {
                        this.silentAudio.play().catch(err => {
                            console.error('Error resuming silent audio:', err);
                        });
                    }
                },
                async acknowledge() {
                    if (this.isAlertActive) {
                        // Arr√™ter imm√©diatement sonnerie et vibrations
                        this.stopAlert();
                        
                        // Envoyer le statut RECEIVED au serveur
                        try {
                            const response = await fetch(`/departManoeuvre/${this.agentData.matricule}`, {
                                method: 'POST'
                            });
                            if (response.ok) {
                                // Mettre √† jour le statut localement
                                this.agentData.statusAlerte = 'RECEIVED';
                                this.isAlertActive = false;
                                // Rafra√Æchir les donn√©es
                                await this.fetchData();
                            }
                        } catch (err) {
                            console.error('Error acknowledging:', err);
                            // R√©activer l'alerte si erreur
                            if (this.agentData.statusAlerte === 'DONE') {
                                this.isAlertActive = true;
                                this.startAlert();
                            }
                        }
                    }
                },
                refreshData() {
                    this.fetchData();
                },
                disconnect() {
                    this.stopAlert();
                    // Demander confirmation pour d√©connecter
                    if (!confirm("√ätes-vous s√ªr de vouloir vous d√©connecter ?")) {
                        return;
                    }
                    if (this.refreshInterval) clearInterval(this.refreshInterval);
                    if (this.timeInterval) clearInterval(this.timeInterval);
                    if (this.audio) {
                        this.audio.pause();
                        this.audio = null;
                    }
                    if (this.silentAudio) {
                        this.silentAudio.pause();
                        this.silentAudio = null;
                    }
                    this.screen = 'login';
                    this.agentData = null;
                    this.data = null;
                }
            },
            beforeUnmount() {
                this.stopAlert();
                if (this.refreshInterval) clearInterval(this.refreshInterval);
                if (this.timeInterval) clearInterval(this.timeInterval);
                if (this.audio) {
                    this.audio.pause();
                    this.audio = null;
                }
                if (this.silentAudio) {
                    this.silentAudio.pause();
                    this.silentAudio = null;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
